# MVP 阶段性汇报与工作日志

**版本截止**: v0.3.5
**时间范围**: 2026-01-19 至 2026-02-06

---

## 🚀 1. 项目整体进度汇报 (MVP 完成)

本项目已完成 MVP (Minimum Viable Product) 开发，并快速迭代至 v0.3.5 版本，形成了基于 DB-First（SSOT）的数据闭环与可持续迭代基础。

### 核心功能模块
*   **数据采集 (Data Acquisition)**:
    *   支持从 IoTDB 批量读取数据，具备 **Level 3 兜底机制**（本地文件缺失时自动拉取）。
    *   支持数据自动降采样和标准化命名 (`v0.2.3`)。
*   **数据标注 (Annotation)**:
    *   集成 Web 标注工具，支持时序异常区间的可视化标注。
    *   新增 **算法预标注加载**：支持加载 "ChatTS" 和 "Qwen" 的检测结果，并以不同颜色（粉紫色）区分显示 (`v0.2.2`)。
*   **模型微调 (Training)**:
    *   集成 **LLaMA-Factory** 框架，建立了统一的微调服务。
    *   支持 **ChatTS-14B/8B** 和 **Qwen3-VL** (`v0.3.0`) 的 LoRA/QLoRA 微调。
    *   **监控增强**：优化了训练日志流式监控与错误诊断，提升了数据集管理的易用性 (`v0.3.2`)。
*   **推理检测 (Inference)**:
    *   **ChatTS**: 基于与语言模型的时序异常检测。
    *   **Qwen-VL**: 新增 **多模态视觉语言模型** 检测能力，引入图像生成与 VLM 推理 (`v0.3.0`)。
    *   **自动化**: 结果自动同步至工作空间，实现“即生成即见”。
*   **索引与审核 (Index & Review)**:
    *   **推理置信度产物**: 生成 `metrics.json` / `segments.json` 并入库索引 (`v0.3.3`)。
    *   **候选/审核队列**: 置信度筛选、抽样策略、批量审核与进度统计 (`v0.3.3`)。
    *   **训练导出**: 仅使用 `approved` 数据 (`v0.3.3`)。
*   **数据资产与迁移 (Asset & Migration)**:
    *   新增 `/api/v1/assets` 数据资产 API，统一数据集与导出入口 (`v0.3.5`)。
    *   新增 DB 迁移机制与启动自动迁移能力，降低环境升级风险 (`v0.3.5`)。

### 平台架构
*   **Monorepo 架构**: 统一管理前后端、微服务 (ilabel, training) 和共享配置，极大提升了跨模块协作效率。
*   **全链路闭环**: 打通了 `采集 -> 标注 -> 训练 -> 推理 -> 监控` 的迭代循环。

---

## 📅 2. 每日开发工作详情

### 🗓️ 开发日历 (2026.01)

| Mon | Tue | Wed | Thu | Fri | Sat | Sun |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| **19**<br>后端搭建<br>基础API | **20**<br>v0.1.0 发布<br>Monorepo重构 | **21**<br>Git冲突解决<br>环境稳定化 | **22**<br>推理Bug修复<br>运行时环境 | **23**<br>v0.2.1/v0.2.2<br>标注/UI优化 | **24**<br>*(休息)* | **25**<br>*(休息)* |
| **26**<br>Annotator修复<br>链路优化启动 | **27**<br>v0.3.0 Qwen集成<br>Level 3兜底 | **28**<br>组件完善<br>售后清单输出 | **29**<br>UI交互修复<br>绘图统一 | **30**<br>v0.3.2<br>训练服务加固 | **31**<br>*(休息)* | **Feb 1**<br>*(休息)* |

---

### 📊 按周工作内容汇总

| 周次 | 时间范围 | 周目标 | 关键交付 |
| :--- | :--- | :--- | :--- |
| Week 1 | 2026-01-19 ~ 2026-01-25 | 完成 MVP 基础闭环与主干框架搭建 | FastAPI + Gradio 基础能力、Monorepo 重构、核心 API 联调、标注/推理体验优化（v0.1.0 ~ v0.2.2） |
| Week 2 | 2026-01-26 ~ 2026-02-01 | 打通多模态链路并加固训练可用性 | Qwen-VL 推理/训练集成（v0.3.0）、Level 3 数据兜底、绘图风格统一、训练日志与数据列表治理（v0.3.2） |
| Week 3 | 2026-02-02 ~ 2026-02-08（截至 2/6） | 建立索引审核闭环并推进 DB-First 架构落地 | 训练筛选与评估框架补齐（v0.3.2）、候选/审核队列与训练导出约束（v0.3.3）、统一环境双模式 + 资产 API + DB 迁移机制（v0.3.5） |

**Week 1（1/19-1/25）总结**
*   完成 MVP 从“后端骨架 -> UI 入口 -> API 联调”的可运行闭环。
*   完成 Monorepo 重构与基础环境稳定化，为后续多模块协作打底。
*   标注与推理体验进入可用阶段（自动可视化、结果同步、批量操作）。

**Week 2（1/26-2/1）总结**
*   多模态能力上线：Qwen-VL 推理与训练链路打通，突破纯时序方案边界。
*   数据链路鲁棒性增强：Level 3 兜底与统一命名规范落地。
*   训练体验加固：日志监控、异常提示、数据列表清洗与绘图统一。

**Week 3（2/2-2/6）总结**
*   完成“评估框架 -> 索引入库 -> 候选与审核 -> 训练导出”的闭环升级。
*   推进平台层改造：统一环境/兼容环境双模式、DB 迁移机制、资产 API 化。
*   明确 DB-First（SSOT）方向并完成首批回归测试，降低后续迭代风险。

---

### 2月6日 (v0.3.5 - DB-First 落地与一致性修复)
> **阶段目标**: 完成 P0/P1 整改项，打通“标注-审核-资产-导出”统一链路。

*   **数据库迁移机制上线**:
    *   新增迁移执行器与脚本：`src/db/migration.py`、`src/db/migrations/0001_add_core_indexes.sql`、`scripts/db_migrate.py`。
    *   主服务启动自动应用迁移（`src/main.py`），降低环境升级失败风险。
*   **数据资产 API 化**:
    *   新增 `/api/v1/assets`（数据集列表/详情/保存/删除、来源筛选、训练导出）。
    *   训练 UI 资产管理改为通过 API 读写，减少直连 DB 带来的口径不一致。
*   **链路一致性与回归**:
    *   修复推理状态枚举不一致（`PROCESSING -> RUNNING`）、补齐 `convert_to_annotation_format` 导出链路。
    *   恢复 Annotator 默认鉴权并提供开发态显式绕过开关。
    *   新增最小回归测试：`tests/test_p0_smoke.py`、`tests/test_model_eval_regression.py`、`tests/test_review_api_integration.py`。

### 2月5日 (联调与整改收敛)
> **阶段目标**: 为 2 月 6 日平台改造发布完成联调与验收口径收敛。

*   **联调状态**:
    *   根据 Git 提交记录，当日无独立功能发布提交（2/5 无 commit）。
    *   主要进行 P0/P1 问题收敛、接口联调与回归项清单确认。
*   **文档与方案准备**:
    *   收敛 DB-First（SSOT）落地边界与优先级执行顺序（P0 -> P1 -> P2）。
    *   明确 2/6 改造发布的验收标准与变更范围。

### 2月4日 (v0.3.5 - 环境统一与部署双模式)
> **阶段目标**: 统一运行环境并保留回退路径，提升部署稳定性。

*   **统一环境增强**:
    *   补齐缺失依赖（如 `tiktoken`、`tyro`、`openpyxl`），并为关键依赖增加版本上限约束。
    *   验证统一环境可同时支持 ChatTS/Qwen 的推理与微调。
*   **ENV_MODE 双模式**:
    *   新增 `ENV_MODE=unified/legacy`，默认统一环境，保留兼容回退模式。
    *   `setup_dev.sh` 增加模式提示，降低部署误配概率。

### 2月3日 (v0.3.3 - 索引与审核闭环)
> **阶段目标**: 引入推理置信度产物与 DB 索引，落地候选/审核队列。

*   **推理结果索引化**:
    *   推理结束自动产出 `metrics.json` / `segments.json` 并写入 `inference_results`、`segment_scores` 等索引实体。
    *   增加历史 CSV 回填脚本 `scripts/backfill_inference_index.py`。
*   **候选/审核流程上线**:
    *   候选队列支持置信度筛选、TopK/低置信度/随机抽样。
    *   审核队列支持状态流转、批量审核与进度统计。
*   **训练导出约束**:
    *   训练导出默认仅使用 `approved` 审核通过数据（单用户 MVP 口径）。

### 2月2日 (v0.3.2 - 训练筛选与评估能力补齐)
> **阶段目标**: 降低训练配置复杂度，并补齐推理评估基础能力。

*   **训练与对比 UI 优化**:
    *   训练界面新增训练方式过滤（`lora/full/all`）与模型联动筛选。
    *   LoRA 适配器改为“任务 + checkpoint（可选）”两级选择，减少噪声。
    *   模型对比新增模型类型/训练方式/checkpoint 筛选条件。
*   **评估框架补齐**:
    *   新增 `services/inference/evaluation/` 评估模块基础结构（`base.py`、`registry.py`、`eval_metrics.py`、`simple_accuracy.py`、`lb_eval.py`）。
    *   为后续置信度索引与训练后评估提供统一扩展接口。

### 1月30日 (v0.3.2 - 训练服务加固)
> **阶段目标**: 解决训练环境兼容性与日志监控问题，确保微调功能稳定可用。

*   **训练日志修复**:
    *   **LLaMA-Factory 兼容性**: 修复 `transformers` (v5.0.0) 缺失 `AutoModelForVision2Seq` 导致的启动崩溃问题。
    *   **日志读取优化**: 修复 UI 日志轮询的静默失败问题，增加进程异常退出的显式状态提示 (`Exit Code` 捕捉)。
*   **数据列表清洗**:
    *   在“开始训练”与“数据资产管理”界面，自动过滤系统文件 (`dataset_info`, `_pipeline_tmp`, 隐藏文件)，确保列表整洁。

### 1月29日 (UI 交互与状态管理修正)
> **阶段目标**: 修复多模态切换导致的状态污染与显示错误。

*   **UI 交互修复**:
    *   **Dropdown 交叉污染**: 修复 ChatTS/Qwen 模式切换时列表未正确重置的问题，防止 Qwen 模式下显示 ChatTS 文件。
    *   **校验逻辑增强**: 修复 Dropdown 刷新时的校验报错 (`Value not in choices`)。
*   **绘图风格统一**:
    *   重构 `plot_utils.py`，统一数据获取与训练预览的绘图逻辑。
    *   实现预览图自动缓存 (`thumbnails`)，解决动态生成风格不一致与文字重叠问题。

### 1月28日 (基础组件完善)
> **阶段目标**: 完善数据采集脚本与售后支持文档。

*   **脚本优化**:
    *   修复 `get_downsampled.py` 的模块引用路径问题 (`sys.path` 深度修正)。
    *   移除脚本中的硬编码绘图逻辑，接入统一绘图工具库。
*   **项目文档**:
    *   输出标准化《售后服务清单》，规范化问题记录与技术支持流程。
### 1月27日 (v0.3.0 - 多模态集成) ⭐
> **阶段目标**: 突破纯时序限制，集成 Qwen-VL 多模态大模型。

*   **多模态推理集成**:
    *   开发 `qwen_detect.py`，实现时序数据转图像、Prompt 构建及 VLM 推理逻辑。
    *   升级 `run.py` 适配器，支持 `--method qwen`，实现与现有系统的无缝兼容。
*   **多模态训练集成**:
    *   创建 `train_qwen_vl.sh`，打通 LLaMA-Factory 的多模态微调链路。
*   **数据链路优化 (v0.2.3)**:
    *   实施 Level 3 数据兜底机制，增强系统鲁棒性。
    *   统一全局文件命名规范，并新增 `scripts/repair_data.py` 修复工具。
    *   抽离 `config/iotdb_config.json` 实现配置共享。

### 1月26日 (服务修复与架构设计)
> **阶段目标**: 解决标注服务访问问题，设计数据链路优化方案。

*   **Annotator 访问修复**:
    *   解决标注服务绑定地址 (`localhost` vs `0.0.0.0`) 问题，确保局域网可访问 (`192.168.199.126`)。
    *   修复推理结果文件在标注界面的可见性问题。
*   **Pipeline 架构设计**:
    *   规划 v0.2.3 的数据链路优化方案（Level 3 兜底）。
    *   确定新的统一文件命名规范 `{PointID}_{StartTime}_{EndTime}_{Algorithm}.csv`。

### 1月23日 (v0.2.1 / v0.2.2 - 体验优化)
> **阶段目标**: 提升标注与推理的用户体验。

*   **标注增强**:
    *   实现 CSV 自动可视化，打开文件即渲染波形与异常区间。
    *   新增 "算法结果" 动态标签分类。
*   **推理 UI 优化**:
    *   实现结果文件自动软链同步。
    *   新增批量下载与批量删除功能，优化任务管理交互。
    *   **交互细节优化**: 修复任务停止反馈逻辑，折叠任务历史面板以精简界面 (`v0.2.1`)。

### 1月22日 (推理服务调试)
> **阶段目标**: 修复推理模块运行错误，确保流程跑通。

*   **Bug 修复**:
    *   修复 Transformer 库版本导致的 `ImportError: LossKwargs`。
    *   修复 UI 组件定义缺失导致的启动崩溃。
    *   修正 `run.py` 参数解析逻辑。

### 1月21日 (联调与稳定)
> **阶段目标**: Monorepo 整合后的环境稳定化。

*   **冲突解决**: 处理 `ilabel` 子模块合并冲突。
*   **环境修复**: 统一各子模块的依赖版本。

### 1月20日 (MVP 发布 v0.1.0 -> v0.2.0)
> **阶段目标**: 完成核心功能闭环与 Monorepo 重构。

*   **v0.1.0 闭环**:
    *   实现推理结果自动反馈闭环逻辑。
    *   完成各服务模块的 API 联调。
*   **v0.2.0 重构**:
    *   确立 Monorepo 架构，整合所有子仓库。
    *   实现版本管理 API (`/api/v1/iteration`)。
    *   统一 WebUI 入口 (`training_ui.py`)。

### 1月19日 (基础设施搭建)
> **阶段目标**: 搭建后端框架与基础服务。

*   **基础架构**:
    *   搭建 FastAPI 后端项目骨架。
    *   配置 Celery 任务队列。
*   **服务开发**:
    *   完成数据、标注、微调三大服务的基础 API 开发。
    *   搭建 Gradio 微调参数配置界面雏形。
