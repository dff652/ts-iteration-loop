# MVP+ 需求与功能设计评审

**范围**  
- 代码分支：`mvp-iteration/dev`  
- 评审时间：2026-02-03  
- 评审对象：MVP+ 推理置信度索引、候选/审核队列、训练评估、数据资产管理（点位级）

---

## 1. 结论摘要

- **总体结论**：MVP+ 的核心闭环功能基本可用，但需要在“数据资产 API 化、数据迁移、作业管理与权限控制”上补齐，才能稳定进入多人或生产环境。  
- **MVP 可交付**：可继续使用 Gradio 作为 MVP 技术栈，不建议在本阶段切换前端框架。  
- **主要风险**：数据库迁移缺失、数据资产管理仅 UI 直连 DB、训练评估作业无独立任务追踪、权限/审计不完善。

---

## 2. 需求覆盖度

| 需求 | 现状 | 说明 |
|------|------|------|
| 推理结果置信度指标 | ✅ 已实现 | 生成 `metrics.json` / `segments.json`，写入索引表 |
| 置信度筛选/排序/候选队列 | ✅ 已实现 | Annotator API + 前端筛选/队列 |
| 训练后黄金集评估 | ✅ 已实现 | 手动/自动评估、写 `eval_results.json` + `model_evals` |
| 审核模块 | ✅ 已实现 | 抽样策略、审核状态流转、批量审核 |
| 数据资产管理（点位级） | ✅ 初版 | 可构建 train/golden，互斥校验、冻结、半自动抽样 |
| 训练数据集导出 | ✅ 初版 | 支持从数据集导出 JSONL（仅 approved） |
| 数据资产 API | ⏳ 未实现 | 当前为 UI 直连 DB |
| 迁移/版本化 | ⏳ 未实现 | 仅 `init_db()` 创建表 |

---

## 3. 架构与流程评审

### 3.1 数据流

- **推理** → `metrics/segments` → `inference_results` / `segment_scores`  
- **标注** → `ReviewQueue` 审核 → 导出训练数据  
- **训练** → 产物目录 → 手动/自动评估 → `model_evals`  
- **数据资产** → 点位集合（train/golden） → 训练导出/评估筛选

### 3.2 数据库结构要点

- 索引与流程：`InferenceResult` / `SegmentScore` / `ReviewQueue`  
- 评估：`ModelEval`  
- 数据资产：`DatasetAsset` / `DatasetItem`

---

## 4. 关键发现（按严重度）

### 4.1 高

- **缺少数据库迁移**  
  - 当前依赖 `init_db()` 创建表，历史 DB 无法自动升级。  
  - 建议引入最小迁移策略（如 Alembic）或一次性迁移脚本。

- **数据资产管理仅在 UI 直连 DB**  
  - 缺少 API 层与权限控制，难以对外扩展与测试。  
  - 建议补 `/api/v1/assets/...`，将 UI 逻辑下沉到 API。

### 4.2 中

- **训练评估作业无统一任务追踪**  
  - 自动评估通过后台线程触发，重启后状态不可追溯。  
  - 建议使用任务表或 Celery 任务队列，统一生命周期管理。

- **评估依赖路径约定**  
  - 黄金集目前依赖路径与命名规则，缺少明确的“数据集版本/快照”。  
  - 建议评估直接读取 `DatasetAsset` 的点位集合 + 配置记录。

- **训练数据导出与审核依赖 ReviewQueue**  
  - 若审核数据不完整，会导致导出为空。  
  - 建议提供 “未审核导出”或“只导出已审核”双策略入口。

### 4.3 低

- **多用户隔离尚未覆盖数据资产**  
  - 资产集合未区分用户/团队。  
  - 建议补 `owner` 字段或组织维度。

- **UI 初始化依赖用户手动刷新**  
  - 数据集、点位列表初始为空，需要用户点击刷新。  
  - 可以在加载时触发一次 refresh 逻辑。

---

## 5. 功能设计评审建议

### 5.1 数据资产管理

- **合理性**：点位级粒度适合 MVP，避免过早复杂化。  
- **约束要求**：  
  - train 与 golden 点位互斥  
  - golden 冻结不可修改  
  - 资产构建记录落库（筛选条件、策略、操作者）

### 5.2 训练/评估闭环

- **建议路径**：  
  - 训练数据导出与评估统一以数据集资产为输入  
  - 训练评估任务记录到 `Task` 表或新增 `EvalTask`

### 5.3 技术栈

- **Gradio**：当前适合 MVP，但不足以支撑复杂权限与协作。  
- **建议**：MVP 后期再切换到 Vue/React，避免当前研发成本上升。

---

## 6. 测试与验证缺口

- 缺少自动化测试（评估、导出、审核流程）  
- 缺少性能验证（批量点位、长序列）  
- 建议补最小回归测试：  
  - 推理指标写入  
  - 数据集构建与导出  
  - 评估输出与入库

---

## 7. 推荐下一步（按优先级）

1. 补数据资产 API 层  
2. 增加 DB 迁移或一次性升级脚本  
3. 评估任务统一进入任务队列  
4. 数据资产与权限/审计绑定  
5. 增加最小回归测试套件

---

## 8. 结语

当前 MVP+ 已能形成“推理→筛选→审核→训练→评估”的闭环。  
下一阶段建议重点补齐可运维性与可追溯性（迁移、API、权限、任务追踪）。
